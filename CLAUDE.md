# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Monte Carlo-based German retirement planning simulator that models accumulation, transition, and decumulation phases across different pension strategies (Rürup, Level 3/L3, Broker accounts). Uses historical FRED data (Wilshire 5000, 10Y Treasury) with bootstrapped returns.

## Commands

```bash
# Install dependencies
poetry install

# Run full analysis with visualizations (generates 5 graphs)
poetry run python main.py

# Run simple scenario comparison (boxplot output)
poetry run python calculator.py

# Run a specific test file
poetry run python test_corrections.py

# Type checking
poetry run mypy .

# Linting
poetry run ruff check .
```

## Architecture

### Data Flow
```
params.py (config) → scenario_*.py (3 strategies) → simulation.py (Monte Carlo) → visualizations.py (5 charts)
```

### Core Components

**`params.py`** - Central `Params` class with 80+ configurable parameters (ages, fees, taxes, returns, mortality)

**`scenario_base.py`** - Base infrastructure:
- `Pot` dataclass: Tracks account balances (rurup, br_eq, br_bd, l3_eq with cost basis)
- `Scenario` base class: Template with `accumulate()`, `transition_year()`, `decumulate_year()` lifecycle
- `withdraw()`: Tax-optimized withdrawal ordering (bonds → equity allowance → L3 → equity)
- Numerical stability helpers: `safe_add()`, `safe_multiply()`, `validate_portfolio_value()`

**`simulation.py`** - Monte Carlo engine:
- `simulate_montecarlo()`: Main entry point returning `SimulationResult` TypedDict
- `collect_return_windows()`: Bootstrap overlapping windows from historical data
- Tracks percentile trajectories (p10, p50, p90)

**`historical_returns.py`** - FRED API data fetching with `data_cache/` pickle storage

**`lifetime.py`** - German mortality tables (Destatis 2018-2020) for stochastic lifetimes

### Active Scenarios (3 strategies)

All inherit from `Scenario` in `scenario_base.py`:
- `ScenarioBroker` - Pure broker account (baseline)
- `ScenarioRurupBroker` - Rürup + broker with tax refund reinvestment (tax-optimized)
- `ScenarioEnhancedL3Broker` - L3 + broker with dynamic withdrawal (max tax efficiency)

### Visualizations (5 focused graphs)

Generated by `main.py` using methods in `visualizations.py`:
1. **graph1_probability_bands.png** - Remaining pot with P10/P50/P90 bands over retirement
2. **graph2_success_comparison.png** - Success probability comparison (bar chart)
3. **graph3_income_composition.png** - Income sources stacked area (pension/rurup/broker)
4. **graph4_metrics_table.png** - Scenario comparison summary table
5. **graph5_risk_return.png** - Risk-return tradeoff scatter plot

### Key German Tax Concepts in Code

- **Teilfreistellung (TFS)**: Partial tax exemption - 30% for equity ETFs (`tfs_broker`), 15% for insurance products (`tfs_insurance`)
- **Sparerpauschbetrag**: Capital gains allowance (€1,000) applied in `withdraw()`
- **Halbeinkünfteverfahren**: 50% taxation on L3 gains after 12 years (12/62 rule)
- **Vorabpauschale**: Advance lump sum tax calculated in `calculate_vorabpauschale()`

## Testing

Tests are standalone Python scripts (not pytest):
- `test_corrections.py` - Mathematical validation
- `test_tax_logic.py` - Tax calculation verification
- `test_overflow_protection.py` - Numerical stability
- `test_visualizations.py` - Chart generation
